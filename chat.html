<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Chat vocal & texte</title>
  <style>
    body {
      margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #36393f; color: white; display: flex; height: 100vh;
      overflow: hidden;
    }

    /* Sidebar salons */
    #sidebar {
      width: 220px;
      background: #2f3136;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #202225;
    }
    #sidebar h3 {
      padding: 15px;
      margin: 0;
      border-bottom: 1px solid #202225;
      font-weight: normal;
    }
    #channels {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    #channels button {
      width: 100%;
      padding: 10px 15px;
      background: transparent;
      border: none;
      color: #b9bbbe;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    #channels button.active,
    #channels button:hover {
      background: #40444b;
      color: white;
      font-weight: bold;
    }

    /* Chat + vocal container */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #36393f;
    }

    /* Chat messages */
    #chat-box {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #2f3136;
    }
    .message {
      margin-bottom: 10px;
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 10px;
      background: #40444b;
      word-wrap: break-word;
      font-size: 14px;
    }
    .message.self {
      background: #7289da;
      margin-left: auto;
    }
    .message .username {
      font-weight: bold;
      margin-bottom: 4px;
      display: block;
    }
    .message .time {
      font-size: 10px;
      color: #b9bbbe;
      float: right;
    }

    /* Input area */
    #form {
      display: flex;
      border-top: 1px solid #202225;
      padding: 10px;
      background: #2f3136;
    }
    #message-input {
      flex: 1;
      padding: 12px;
      border-radius: 5px;
      border: none;
      font-size: 14px;
      color: white;
      background: #40444b;
    }
    #send-btn {
      background: #7289da;
      border: none;
      padding: 12px 20px;
      color: white;
      margin-left: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #send-btn:hover {
      background: #5b6eae;
    }

    /* Voice chat */
    #voice-chat {
      border-top: 1px solid #202225;
      background: #2f3136;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #join-call, #mute-btn {
      background: #7289da;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #join-call:hover, #mute-btn:hover {
      background: #5b6eae;
    }
    #mute-btn:disabled {
      background: #444851;
      cursor: not-allowed;
    }
    #call-status {
      flex: 1;
      font-size: 14px;
      color: #b9bbbe;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <h3>Salons</h3>
    <div id="channels">
      <!-- Boutons salons -->
      <button class="active" data-channel="general"># général</button>
      <button data-channel="random"># random</button>
      <button data-channel="voix"># discussion vocale</button>
    </div>
  </div>

  <div id="main">
    <div id="chat-box"></div>

    <form id="form">
      <input type="text" id="message-input" placeholder="Écris un message..." autocomplete="off" />
      <button type="submit" id="send-btn">Envoyer</button>
    </form>

    <div id="voice-chat">
      <button id="join-call">Rejoindre l'appel</button>
      <button id="mute-btn" disabled>Mute</button>
      <div id="call-status">Tu n’es pas dans l’appel.</div>
    </div>
  </div>

  <script>
    // Récupérer pseudo
    const pseudo = sessionStorage.getItem('pseudo');
    if (!pseudo) {
      alert('Pas de pseudo détecté. Retour à la connexion.');
      window.location.href = 'index.html';
    }

    // Gestion des salons
    const channels = document.querySelectorAll('#channels button');
    let activeChannel = 'general';

    channels.forEach(btn => {
      btn.addEventListener('click', () => {
        channels.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeChannel = btn.dataset.channel;
        loadMessages(activeChannel);
      });
    });

    // Stockage local des messages par salon
    const messagesDB = {};

    function loadMessages(channel) {
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = '';
      if (!messagesDB[channel]) return;
      messagesDB[channel].forEach(msg => {
        displayMessage(msg, channel === 'general');
      });
    }

    function displayMessage(msg, self = false) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.classList.add('message');
      if (self) div.classList.add('self');
      div.innerHTML = '<span class="username">' + msg.username + '</span>' +
                      '<span class="time">' + msg.time + '</span>' +
                      '<div class="text">' + msg.text + '</div>';
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Envoyer un message
    const form = document.getElementById('form');
    const input = document.getElementById('message-input');

    form.addEventListener('submit', e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      const now = new Date();
      const time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');

      const message = {
        username: pseudo,
        text: text,
        time: time,
      };

      if (!messagesDB[activeChannel]) messagesDB[activeChannel] = [];
      messagesDB[activeChannel].push(message);

      if (activeChannel === 'general') {
        displayMessage(message, true);
      }

      input.value = '';
    });

    // Charger salon initial
    loadMessages(activeChannel);

    // --- Discussion vocale basique ---
    let localStream;
    let isMuted = false;

    const joinBtn = document.getElementById('join-call');
    const muteBtn = document.getElementById('mute-btn');
    const callStatus = document.getElementById('call-status');

    joinBtn
